{% extends "base.html" %}

{% block content %}
<!-- Cabe√ßalho Responsivo -->
<div class='d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4'>
  <div class='mb-3 mb-md-0'>
    <h3 class='mb-1'>üí∞ Controle de Mensalidades</h3>
    <p class="text-muted mb-0">Gerencie as mensalidades de todos os s√≥cios com visualiza√ß√£o completa por m√™s e ano.</p>
  </div>
</div>

<!-- Formul√°rio de Filtros -->
<div class='card p-3 mb-4 shadow-sm'>
  <h5 class="mb-3">üîç Filtros</h5>
  <form method='get' class='row g-3'>
    <div class='col-12 col-md-3'>
      <label class="form-label">M√™s</label>
      <select name='mes' class='form-select'>
        <option value=''>Todos os meses</option>
        {% for mes in meses %}
        <option value='{{ mes }}' {% if filtros.mes == mes %}selected{% endif %}>{{ mes }}</option>
        {% endfor %}
      </select>
    </div>
    <div class='col-12 col-md-2'>
      <label class="form-label">Ano</label>
      <select name='ano' class='form-select'>
        <option value=''>Todos os anos</option>
        {% for ano in anos %}
        <option value='{{ ano }}' {% if filtros.ano == ano|string %}selected{% endif %}>{{ ano }}</option>
        {% endfor %}
      </select>
    </div>
    <div class='col-12 col-md-3'>
      <label class="form-label">S√≥cio</label>
      <select name='socio_id' class='form-select'>
        <option value=''>Todos os s√≥cios</option>
        {% for socio in socios %}
        <option value='{{ socio.id }}' {% if filtros.socio_id == socio.id|string %}selected{% endif %}>{{ socio.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class='col-12 col-md-4'>
      <div class='d-flex flex-column flex-sm-row gap-2 align-items-sm-end'>
        <button type='submit' class='btn btn-outline-primary flex-fill flex-sm-grow-0'>
          üîç Filtrar
        </button>
        <a href='{{ url_for("associados") }}' class='btn btn-outline-secondary flex-fill flex-sm-grow-0'>
          üîÑ Limpar
        </a>
        <a href='/pdf-mensalidades{% if filtros.ano %}?ano={{ filtros.ano }}{% endif %}' 
           class='btn btn-danger flex-fill flex-sm-grow-0'>
          üì• Baixar PDF
        </a>
      </div>
      {% if filtros.mes or filtros.ano or filtros.socio_id %}
      <div class='mt-2'>
        <span class="badge bg-info">
          {{ mensalidades_por_socio.values() | list | length }} s√≥cio(s) filtrado(s)
        </span>
      </div>
      {% endif %}
    </div>
  </form>
</div>

<!-- Formul√°rio para incluir nova mensalidade -->
{% if current_user.is_admin() %}
<div class='card p-3 mb-4 shadow-sm'>
  <h5 class="mb-3">‚ûï Incluir Nova Mensalidade</h5>
  <form method='post' class='row g-3'>
    <div class='col-12 col-md-3'>
      <label class="form-label">S√≥cio</label>
      <select name='jogador_id' class='form-select' required>
        <option value=''>Selecione o s√≥cio</option>
        {% for socio in socios %}
        <option value='{{ socio.id }}'>{{ socio.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class='col-12 col-md-2'>
      <label class="form-label">M√™s</label>
      <select name='mes' class='form-select' required>
        <option value=''>M√™s</option>
        <option value='Janeiro' {% if mes_atual == 'Janeiro' %}selected{% endif %}>Janeiro</option>
        <option value='Fevereiro' {% if mes_atual == 'Fevereiro' %}selected{% endif %}>Fevereiro</option>
        <option value='Mar√ßo' {% if mes_atual == 'Mar√ßo' %}selected{% endif %}>Mar√ßo</option>
        <option value='Abril' {% if mes_atual == 'Abril' %}selected{% endif %}>Abril</option>
        <option value='Maio' {% if mes_atual == 'Maio' %}selected{% endif %}>Maio</option>
        <option value='Junho' {% if mes_atual == 'Junho' %}selected{% endif %}>Junho</option>
        <option value='Julho' {% if mes_atual == 'Julho' %}selected{% endif %}>Julho</option>
        <option value='Agosto' {% if mes_atual == 'Agosto' %}selected{% endif %}>Agosto</option>
        <option value='Setembro' {% if mes_atual == 'Setembro' %}selected{% endif %}>Setembro</option>
        <option value='Outubro' {% if mes_atual == 'Outubro' %}selected{% endif %}>Outubro</option>
        <option value='Novembro' {% if mes_atual == 'Novembro' %}selected{% endif %}>Novembro</option>
        <option value='Dezembro' {% if mes_atual == 'Dezembro' %}selected{% endif %}>Dezembro</option>
      </select>
    </div>
    <div class='col-12 col-md-2'>
      <label class="form-label">Ano</label>
      <input type='number' name='ano' min='2000' max='2100' 
             id='ano_input'
             value='{{ ano_atual }}'
             class='form-control' required>
    </div>
    <div class='col-12 col-md-3'>
      <label class="form-label">Valor R$</label>
      <input type='number' step='0.01' min='0' name='valor' 
             value='{{ valor_padrao or "50.00" }}'
             placeholder='0.00' class='form-control' required>
    </div>
    <div class='col-12 col-md-2'>
      <label class="form-label d-md-none">&nbsp;</label>
      <button type='submit' class='btn btn-primary w-100'>üí∞ Lan√ßar Mensalidade</button>
    </div>
  </form>
</div>
{% endif %}

{% if not socios %}
<div class="alert alert-warning">
  <strong>Aten√ß√£o:</strong> Nenhum s√≥cio cadastrado. Cadastre jogadores do tipo "S√≥cio" primeiro.
</div>
{% else %}
<!-- Tabela com todas as mensalidades -->
<div class='card shadow-sm'>
  <div class='card-body'>
    <h5 class='card-title mb-3'>
      üìä Mensalidades por S√≥cio
      {% if filtros.mes or filtros.ano or filtros.socio_id %}
      <small class="text-muted">(Filtrado)</small>
      {% endif %}
    </h5>
    {% if mensalidades_por_socio %}
    <div class='table-responsive'>
      <table class='table table-hover table-bordered align-middle table-striped'>
        <thead class='table-dark'>
          <tr>
            <th class='d-none d-md-table-cell'>S√≥cio</th>
            <th class='d-md-none'>S√≥cio</th>
            <th class='d-none d-lg-table-cell'>M√™s/Ano</th>
            <th>Valor</th>
            <th class='d-none d-md-table-cell'>Data</th>
            <th class='text-center d-none d-lg-table-cell'>A√ß√µes</th>
            <th class='text-center d-lg-none'>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for socio_id, dados in mensalidades_por_socio.items() %}
            {% set socio = dados.socio %}
            {% set mensalidades = dados.mensalidades %}
            {% set total_pago = dados.total_pago %}
            
            {% if mensalidades %}
              {% for mensalidade in mensalidades %}
              <tr>
                {% if loop.first %}
                <td rowspan="{{ mensalidades|length }}" class="align-middle d-none d-md-table-cell">
                  <strong>{{ socio.nome }}</strong>
                  <br>
                  <small class="text-muted">Total: R$ {{ "%.2f"|format(total_pago) }}</small>
                </td>
                {% endif %}
                <td class='d-md-none'>
                  <div class='border-bottom pb-2 mb-2'>
                    <strong>{{ socio.nome }}</strong>
                    <br>
                    <small class="text-muted">Total: R$ {{ "%.2f"|format(total_pago) }}</small>
                  </div>
                </td>
                <td class='d-none d-lg-table-cell'>
                  <span class="badge bg-info">{{ mensalidade.mes_referencia or 'N/A' }}</span>
                </td>
                <td class="text-success">
                  <strong>R$ {{ "%.2f"|format(mensalidade.valor) }}</strong>
                </td>
                <td class='d-none d-md-table-cell'>
                  <small>{{ mensalidade.data.strftime('%d/%m/%Y') }}</small>
                </td>
                <td class='text-center d-none d-lg-table-cell'>
                  {% if current_user.is_admin() %}
                  <form method="post" action="{{ url_for('extornar_mensalidade', mensalidade_id=mensalidade.id) }}" 
                        onsubmit="return confirm('Tem certeza que deseja extornar esta mensalidade? Esta a√ß√£o n√£o pode ser desfeita.');" 
                        style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-danger">
                      Extornar
                    </button>
                  </form>
                  {% endif %}
                </td>
                <td class='text-center d-lg-none'>
                  {% if current_user.is_admin() %}
                  <form method="post" action="{{ url_for('extornar_mensalidade', mensalidade_id=mensalidade.id) }}" 
                        onsubmit="return confirm('Tem certeza que deseja extornar esta mensalidade? Esta a√ß√£o n√£o pode ser desfeita.');" 
                        style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-danger">
                      
                    </button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              <!-- Vers√£o mobile com detalhes -->
              <tr class='d-lg-none'>
                <td colspan='3' class='p-2 bg-light'>
                  <div class='small text-muted'>
                    <strong>M√™s/Ano:</strong> <span class="badge bg-info">{{ mensalidade.mes_referencia or 'N/A' }}</span><br>
                    <strong>Data:</strong> {{ mensalidade.data.strftime('%d/%m/%Y') }}
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7"><strong>{{ socio.nome }}</strong></td>
              </tr>
              <tr class='d-lg-none'>
                <td colspan='3' class='text-center text-muted py-3'>
                  <em>Nenhuma mensalidade registrada</em>
                </td>
              </tr>
              <tr class='d-none d-lg-table-row'>
                <td colspan="6" class="text-center text-muted">
                  <em>Nenhuma mensalidade registrada</em>
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
        <tfoot class="table-secondary">
          <tr>
            <th colspan="2" class='d-none d-md-table-cell'>Total Geral</th>
            <th colspan="1" class='d-md-none d-lg-none'>Total Geral</th>
            <th class="text-success">
              R$ {{ "%.2f"|format(total_geral) }}
            </th>
            <th colspan="4" class='d-none d-lg-table-cell'></th>
            <th colspan="2" class='d-lg-none'></th>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <div class="text-center py-4">
      <p class="text-muted">
        {% if filtros.mes or filtros.ano or filtros.socio_id %}
        <em>Nenhuma mensalidade encontrada com os filtros selecionados.</em>
        {% else %}
        <em>Nenhuma mensalidade registrada ainda.</em>
        {% endif %}
      </p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Resumo por ano -->
{% if anos %}
<div class='card shadow-sm mt-4'>
  <div class='card-body'>
    <h5 class='card-title mb-3'>üìÖ Resumo por Ano</h5>
    <div class='row'>
      {% for ano in anos %}
        {% set mensalidades_ano = [] %}
        {% for socio_id, dados in mensalidades_por_socio.items() %}
          {% for mensalidade in dados.mensalidades %}
            {% if mensalidade.ano_referencia == ano %}
              {% set _ = mensalidades_ano.append(mensalidade) %}
            {% endif %}
          {% endfor %}
        {% endfor %}
        {% set total_ano = mensalidades_ano | sum(attribute='valor') %}
        <div class='col-12 col-sm-6 col-lg-4 col-xl-3 mb-3'>
          <div class='card border-primary h-100'>
            <div class='card-body text-center'>
              <h6 class='card-title'>{{ ano }}</h6>
              <p class='card-text'>
                <strong class='text-success'>R$ {{ "%.2f"|format(total_ano) }}</strong>
                <br>
                <small class='text-muted'>{{ mensalidades_ano|length }} mensalidade(s)</small>
              </p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

{% endif %}
{% endblock %}

{% block scripts %}
<script>
  // For√ßar atualiza√ß√£o do formul√°rio com cache-busting
  document.addEventListener('DOMContentLoaded', function() {
    // Adicionar timestamp para evitar cache
    const timestamp = new Date().getTime();
    
    // Definir ano atual como padr√£o
    const anoInput = document.getElementById('ano_input');
    if (anoInput) {
      const anoAtual = new Date().getFullYear();
      anoInput.value = anoAtual;
      anoInput.setAttribute('data-timestamp', timestamp);
    }
    
    // Limpar cache do formul√°rio
    const form = document.querySelector('form[method="post"]');
    if (form) {
      form.reset();
      // For√ßar reload dos valores
      setTimeout(() => {
        const anoInput = document.getElementById('ano_input');
        if (anoInput && !anoInput.value) {
          anoInput.value = new Date().getFullYear();
        }
      }, 100);
    }
    
    // Log para debug
    console.log('Formul√°rio atualizado em:', new Date().toLocaleString());
  });
</script>
{% endblock %}
