{% extends "base.html" %}

{% block content %}
<h4>üìã Presen√ßas e Pagamentos: {{ jogo.adversario }} ({{ jogo.data.strftime('%d/%m/%Y') }})</h4>

<!-- Resumo da Partida -->
<div class='card p-2 p-md-3 mb-4 shadow-sm'>
  <div class='row g-2'>
    <div class='col-6 col-md-3'>
      <div class='card border-primary'>
        <div class='card-body text-center p-2'>
          <h6 class='card-title small'>üë• Confirmados</h6>
          <p class='card-text mb-0'>
            <strong class='text-primary'>{{ total_confirmados }}</strong>
            <br>
            <small class='text-muted'>jogadores</small>
          </p>
        </div>
      </div>
    </div>
    <div class='col-6 col-md-3'>
      <div class='card border-success'>
        <div class='card-body text-center p-2'>
          <h6 class='card-title small'>üí∞ Arrecadado</h6>
          <p class='card-text mb-0'>
            <strong class='text-success'>R$ {{ "%.2f"|format(total_arrecadado) }}</strong>
            <br>
            <small class='text-muted'>total</small>
          </p>
        </div>
      </div>
    </div>
    <div class='col-6 col-md-3'>
      <div class='card border-danger'>
        <div class='card-body text-center p-2'>
          <h6 class='card-title small'>üí∏ Despesas</h6>
          <p class='card-text mb-0'>
            <strong class='text-danger'>R$ {{ "%.2f"|format(total_despesas) }}</strong>
            <br>
            <small class='text-muted'>despesas</small>
          </p>
        </div>
      </div>
    </div>
    <div class='col-6 col-md-3'>
      <div class='card border-info'>
        <div class='card-body text-center p-2'>
          <h6 class='card-title small'>üíµ Saldo</h6>
          <p class='card-text mb-0'>
            <strong class='text-info'>R$ {{ "%.2f"|format(total_arrecadado - total_despesas) }}</strong>
            <br>
            <small class='text-muted'>saldo</small>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ûï Adicionar Jogador ao Jogo -->
{% if current_user.is_admin() %}
<form method='post' class="mb-3">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">‚ûï Adicionar Jogador ao Jogo</h5>

      <div class="row g-2 align-items-end">
        <div class="col-md-9">
          <select name="novo_jogador_id" id="novo_jogador" class="form-control">
            <option value="">Buscar jogador...</option>
            {% for jogador in todos_jogadores %}
              {% if jogador.id not in participacoes_existentes %}
                <option value="{{ jogador.id }}">{{ jogador.nome }} ({{ jogador.tipo }})</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3 d-grid">
          <button type="submit" name="acao" value="add_jogador" class="btn btn-success">
            Adicionar
          </button>
        </div>
      </div>
    </div>
  </div>
</form>
{% else %}
<!-- Bot√£o para s√≥cio se adicionar ao jogo -->
{% if current_user.jogador and current_user.jogador.tipo == 'SOCIO' %}
  {% set meu_id = current_user.jogador_id %}
  {% set ja_adicionado = false %}
  {% for p in participacoes %}
    {% if p.jogador_id == meu_id %}
      {% set ja_adicionado = true %}
    {% endif %}
  {% endfor %}
  
  {% if not ja_adicionado %}
  <form method='post' class="mb-3">
    <div class="card shadow-sm border-success">
      <div class="card-body">
        <h5 class="mb-3">üéØ Participar do Jogo</h5>
        <p class="mb-3">Deseja se adicionar a este jogo?</p>
        <div class="d-grid">
          <button type="submit" name="acao" value="add_jogador" class="btn btn-success btn-lg">
            ‚úÖ Confirmar Presen√ßa
          </button>
        </div>
      </div>
    </div>
  </form>
  {% else %}
  <div class="card shadow-sm border-info mb-3">
    <div class="card-body">
      <h5 class="mb-3">‚úÖ Voc√™ j√° est√° neste jogo!</h5>
      <p class="mb-0">Sua participa√ß√£o j√° est√° confirmada. Voc√™ pode confirmar presen√ßa na tabela abaixo.</p>
    </div>
  </div>
  {% endif %}
{% endif %}
{% endif %}
<form method='post' novalidate>

  <!-- MOBILE - Cards de Jogadores -->
  <div class="d-md-none">

    {% for p in participacoes_existentes.values() %}
    <div class="card mb-3 shadow-sm">
      <div class="card-body">

        <h6 class="mb-1">{{ p.jogador.nome }}</h6>
        <small class="text-muted">{{ p.jogador.tipo }}</small>

        {% if p.jogador.nativo %}
          <span class="badge bg-info ms-2">üè† Nativo</span>
        {% endif %}

        <hr>

        <div class="mb-2">
          {% if p.pagou %}
            <span class="badge bg-success">‚úÖ Pago</span>
          {% else %}
            <span class="badge bg-warning">‚è≥ N√£o pago</span>
          {% endif %}
        </div>

        {% if current_user.is_admin() or current_user.jogador_id == p.jogador.id %}
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox"
                 name="confirmou_{{ p.id }}"
                 {% if p.confirmou %}checked{% endif %}>
          <label class="form-check-label">Confirmou presen√ßa</label>
        </div>
        {% endif %}

        {% if current_user.is_admin() %}
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox"
                 name="pagou_{{ p.id }}"
                 {% if p.pagou %}checked{% endif %}>
          <label class="form-check-label">Pagamento realizado</label>
        </div>

        <div class="mb-2">
          <label class="form-label">Valor pago</label>
          <input type="number" step="0.01" min="0"
                 name="valor_{{ p.id }}"
                 value="{{ '%.2f'|format(p.valor_pago) }}"
                 class="form-control">
        </div>

        <div class="mb-2">
          <label class="form-label">‚öΩ Gols</label>
          <input type="number" min="0"
                 name="gols_{{ p.id }}"
                 value="{{ p.gols or 0 }}"
                 class="form-control text-center">
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox"
                 name="expulso_{{ p.id }}"
                 {% if p.expulso %}checked{% endif %}>
          <label class="form-check-label">üü• Expulso</label>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="radio"
                 name="craque_id"
                 value="{{ p.jogador.id }}"
                 {% if jogo.craque_id == p.jogador.id %}checked{% endif %}>
          <label class="form-check-label">‚≠ê Craque do jogo</label>
        </div>

        {% if current_user.is_admin() %}
        <div class="d-grid">
          <button formaction="{{ url_for('remover_jogador_partida', jogo_id=jogo.id, jogador_id=p.jogador.id) }}"
                  formmethod="post"
                  class="btn btn-danger"
                  {% if p.lancado_financeiro %}disabled{% endif %}>
            üóëÔ∏è Remover jogador
          </button>
        </div>
        {% endif %}

      </div>
    </div>
    {% endfor %}

  </div>

<form method='post' novalidate>
  <div class='table-responsive shadow-sm bg-white mb-3 d-none d-md-block'>
    <table class='table table-sm table-hover align-middle'>
      <thead class='table-secondary'>
        <tr>
          <th>Jogador</th>
          <th class="d-none d-md-table-cell">Confirmou?</th>
          <th class="d-none d-md-table-cell">Pagou?</th>
          <th>Valor R$</th>
          <th class="d-none d-md-table-cell">‚öΩ Gols</th>
          <th class="d-none d-md-table-cell">üü• Expulso</th>
          <th class="d-none d-md-table-cell">‚≠ê Craque</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for p in participacoes_existentes.values() %}
        <tr>
          <td>
            <div class="d-flex flex-column">
              <strong>{{ p.jogador.nome }}</strong>
              <small class='text-muted'>{{ p.jogador.tipo }}</small>
              {% if p.jogador.nativo %}
              <span class="badge bg-info mt-1">üè† Nativo</span>
              {% endif %}
            </div>
          </td>
          <td class="d-none d-md-table-cell">
            {% if current_user.is_admin() %}
            <input type='checkbox' name='confirmou_{{ p.id }}' {% if p.confirmou %}checked{% endif %}>
            {% elif current_user.jogador_id == p.jogador.id %}
            <input type='checkbox' name='confirmou_{{ p.id }}' {% if p.confirmou %}checked{% endif %} title="Confirmar minha presen√ßa">
            {% else %}
            {% if p.confirmou %}‚úÖ{% else %}‚ùå{% endif %}
            {% endif %}
          </td>
          <td class="d-none d-md-table-cell">
            {% if current_user.is_admin() %}
            <input type='checkbox' name='pagou_{{ p.id }}' {% if p.pagou %}checked{% endif %}>
            {% else %}
            {% if p.pagou %}‚úÖ{% else %}‚ùå{% endif %}
            {% endif %}
          </td>
          <td>
            {% if current_user.is_admin() %}
            <input type='number' step='0.01' min='0' name='valor_{{ p.id }}' 
                   value='{{ "%.2f"|format(p.valor_pago) }}' class='form-control form-control-sm'>
            {% else %}
            R$ {{ "%.2f"|format(p.valor_pago) }}
            {% endif %}
          </td>
          <td class="d-none d-md-table-cell">
            {% if current_user.is_admin() %}
            <input type='number' min='0' name='gols_{{ p.id }}' 
                   value='{{ p.gols or 0 }}' class='form-control form-control-sm text-center'>
            {% else %}
            {{ p.gols or 0 }}
            {% endif %}
          </td>
          <td class="d-none d-md-table-cell text-center">
            {% if current_user.is_admin() %}
            <input type='checkbox' name='expulso_{{ p.id }}' {% if p.expulso %}checked{% endif %}>
            {% else %}
            {% if p.expulso %}üü•{% else %}‚úÖ{% endif %}
            {% endif %}
          </td>
          <td class="d-none d-md-table-cell text-center">
            {% if current_user.is_admin() %}
            <input type='radio' name='craque_id' value='{{ p.jogador.id }}' 
                   {% if jogo.craque_id == p.jogador.id %}checked{% endif %}>
            {% elif jogo.craque_id == p.jogador.id %}
            ‚≠ê
            {% endif %}
          </td>
          <td>
            {% if p.pagou %}
              <span class="badge bg-success">‚úÖ Pago</span>
            {% else %}
              <span class="badge bg-warning">‚è≥ N√£o pago</span>
            {% endif %}
          </td>
          <td>
            {% if current_user.is_admin() %}
            <form method="post" action="{{ url_for('remover_jogador_partida', jogo_id=jogo.id, jogador_id=p.jogador.id) }}" 
                  onsubmit="return confirm('Tem certeza que deseja remover {{ p.jogador.nome }} da partida?');" 
                  style="display: inline;">
              <button type="submit" class="btn btn-sm btn-danger" 
                      {% if p.lancado_financeiro %}disabled title="N√£o pode remover - j√° lan√ßado financeiramente"{% endif %}>
                üóëÔ∏è
              </button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="text-center text-muted">
            <em>Nenhum jogador adicionado √† partida ainda.</em>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  {% if current_user.is_admin() %}
  <!-- Adicionar Despesa de Partida -->
  <div class='card p-3 mb-3 bg-light'>
    <h5>üí∏ Adicionar Despesa de Partida</h5>
    <div class='row g-2'>
      <div class='col-md-4'>
        <select name='categoria_despesa' class='form-control'>
          <option value=''>Selecione...</option>
          <option value='ARBITRO'>√Årbitro</option>
          <option value='AGUA'>√Ågua</option>
          <option value='CAMPO'>Campo de Futebol</option>
          <option value='TRANSPORTE'>Transporte</option>
          <option value='LAVAGEM'>Lavagem</option>
          <option value='ALIMENTACAO'>Alimenta√ß√£o</option>
          <option value='MATERIAL'>Material</option>
          <option value='OUTROS_SAIDA'>Outros</option>
        </select>
      </div>
      <div class='col-md-4'>
        <input name='desc_despesa' placeholder='Descri√ß√£o detalhada' class='form-control'>
      </div>
      <div class='col-md-4'>
        <input type='number' step='0.01' min='0' name='val_despesa' placeholder='Valor R$' class='form-control'>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- Lista de Despesas da Partida -->
  {% if despesas_partida and current_user.is_admin() %}
  <div class='card p-3 mb-3 shadow-sm'>
    <h5 class="mb-3">üìã Despesas da Partida</h5>
    <div class='table-responsive'>
      <table class='table table-sm align-middle'>
        <thead class='table-secondary'>
          <tr>
            <th>Categoria</th>
            <th>Descri√ß√£o</th>
            <th>Valor</th>
            <th>Data</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for despesa in despesas_partida %}
          <tr>
            <td>
            {% if despesa.tipo == 'ARBITRO' %}
              <span class="badge bg-danger">√Årbitro</span>
            {% elif despesa.tipo == 'AGUA' %}
              <span class="badge bg-info">√Ågua</span>
            {% elif despesa.tipo == 'CAMPO' %}
              <span class="badge bg-warning">Campo de Futebol</span>
            {% elif despesa.tipo == 'TRANSPORTE' %}
              <span class="badge bg-secondary">Transporte</span>
            {% elif despesa.tipo == 'LAVAGEM' %}
              <span class="badge bg-success">Lavagem</span>
            {% elif despesa.tipo == 'ALIMENTACAO' %}
              <span class="badge bg-primary">Alimenta√ß√£o</span>
            {% elif despesa.tipo == 'MATERIAL' %}
              <span class="badge bg-dark">Material</span>
            {% else %}
              <span class="badge bg-light text-dark">Outros</span>
            {% endif %}
          </td>
          <td>{{ despesa.descricao.replace("Despesa Jogo " + jogo.data.strftime('%d/%m/%Y') + ": ", "") }}</td>
            <td class="text-danger">
              <strong>R$ {{ "%.2f"|format(despesa.valor) }}</strong>
            </td>
            <td>{{ despesa.data.strftime('%d/%m/%Y') }}</td>
            <td>
              <form method="post" action="{{ url_for('extornar_despesa', despesa_id=despesa.id) }}" 
                    onsubmit="return confirm('Tem certeza que deseja extornar esta despesa?');" 
                    style="display: inline;">
                <button type="submit" class="btn btn-sm btn-danger">
                  üóëÔ∏è Extornar
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class='table-warning'>
          <tr>
            <th colspan="2">Total de Despesas</th>
            <th class="text-danger">
              <strong>R$ {{ "%.2f"|format(total_despesas) }}</strong>
            </th>
            <th colspan="2"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  {% endif %}
  
  <div class="d-grid gap-2 d-md-block">
  <button class="btn btn-primary btn-lg shadow mb-2">
    üíæ Salvar Altera√ß√µes
  </button>

  <a href="/pdf-partida/{{ jogo.id }}" class="btn btn-danger btn-lg mb-2">
    üìÑ Gerar PDF
  </a>

  <a href="/jogos" class="btn btn-secondary btn-lg">
    ‚¨ÖÔ∏è Voltar
  </a>
</div>

</form>

<!-- Select2 para busca din√¢mica -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

{% block scripts %}
<script>
$(document).ready(function() {
    $('#novo_jogador').select2({
        placeholder: "Buscar jogador...",
        allowClear: true,
        theme: "bootstrap-5"
    });
});
</script>
{% endblock %}
{% endblock %}
