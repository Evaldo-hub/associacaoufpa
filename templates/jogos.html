{% extends "base.html" %}

{% block content %}
<h3 class="mb-3">‚öΩ Gest√£o de Jogos</h3>

{# ================= FORMUL√ÅRIO (APENAS ADMIN) ================= #}
{% if current_user.is_authenticated and current_user.is_admin %}
<div class="card p-3 mb-4 shadow-sm">
  <form method="post" action="{{ url_for('jogos') }}" class="row g-2" id="form-jogos">

    <div class="col-12 col-md-2">
      <label class="form-label d-none d-md-block">Data</label>
      <input type="date" name="data" class="form-control" 
             value="{{ data_atual or '' }}" required>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label d-none d-md-block">Advers√°rio</label>
      <input name="adversario" placeholder="Advers√°rio" class="form-control" 
             value="{{ adversario_padrao or '' }}" required>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label d-none d-md-block">Local</label>
      <div class="input-group">
        <input name="local" id="local-input" placeholder="Local" class="form-control"
               value="{{ local_padrao or '' }}">
        <button type="button"
                class="btn btn-outline-secondary"
                onclick="buscarLocalizacao()">
          üìç
        </button>
      </div>
    </div>

    <div class="col-12 col-md-2">
      <label class="form-label d-none d-md-block">Valor Sugerido</label>
      <input type="number" step="0.01" min="0"
             name="valor_jogo"
             placeholder="Valor sugerido"
             value="{{ valor_jogo_padrao or '20.00' }}"
             class="form-control">
    </div>

    <div class="col-12 col-md-1 d-grid">
      <label class="form-label d-none d-md-block">&nbsp;</label>
      <button type="submit" class="btn btn-success">‚öΩ Cadastrar</button>
    </div>

  </form>
</div>
{% endif %}

{# ================= MOBILE (CARDS) ================= #}
<div class="d-block d-md-none">
  {% for jogo in jogos %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body">

      <h5 class="card-title mb-1">
        {{ jogo.adversario or 'Sem advers√°rio' }}
      </h5>

      <p class="mb-1">
        üìÖ {{ jogo.data.strftime('%d/%m/%Y') }}
      </p>

      {% if jogo.local %}
      <p class="mb-2">
        üìç
        <a href="https://www.google.com/maps/search/{{ jogo.local|urlencode }}"
           target="_blank">
           {{ jogo.local }}
        </a>
      </p>
      {% endif %}

      <div class="d-grid gap-2">
        <a href="/presencas/{{ jogo.id }}"
           class="btn btn-outline-primary">
          Presen√ßas / Pagamento
        </a>

        {% if current_user.is_authenticated and current_user.is_admin and not jogo.resumo_texto %}
        <a href="/teste-placar/{{ jogo.id }}"
           class="btn btn-outline-success">
          üìä Placar
        </a>
        {% endif %}

        <a href="/pdf-partida/{{ jogo.id }}"
           class="btn btn-danger">
          üìÑ PDF
        </a>
      </div>

    </div>
  </div>
  {% else %}
    <p class="text-muted text-center">Nenhum jogo cadastrado</p>
  {% endfor %}
</div>

{# ================= DESKTOP (TABELA) ================= #}
<div class="table-responsive bg-white shadow-sm d-none d-md-block">
  <table class="table table-hover mb-0">
    <thead class="table-dark">
      <tr>
        <th>Data</th>
        <th>Advers√°rio</th>
        <th>Local</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {% for jogo in jogos %}
      <tr>
        <td>{{ jogo.data.strftime('%d/%m/%Y') }}</td>
        <td>{{ jogo.adversario or '-' }}</td>
        <td>
          {% if jogo.local %}
          <a href="https://www.google.com/maps/search/{{ jogo.local|urlencode }}"
             target="_blank">
            {{ jogo.local }} üìç
          </a>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          <a href="/presencas/{{ jogo.id }}"
             class="btn btn-sm btn-outline-primary">
            Presen√ßas
          </a>

          {% if current_user.is_authenticated and current_user.is_admin and not jogo.resumo_texto %}
          <a href="/teste-placar/{{ jogo.id }}"
             class="btn btn-sm btn-outline-success">
            üìä
          </a>
          {% endif %}

          <a href="/pdf-partida/{{ jogo.id }}"
             class="btn btn-sm btn-danger">
            üìÑ
          </a>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="4" class="text-center text-muted">
          Nenhum jogo cadastrado
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}

{% block scripts %}
<script>
// For√ßar atualiza√ß√£o do formul√°rio com cache-busting
document.addEventListener('DOMContentLoaded', function() {
  // Adicionar timestamp para evitar cache
  const timestamp = new Date().getTime();
  
  // Limpar cache do formul√°rio
  const form = document.getElementById('form-jogos');
  if (form) {
    form.reset();
    // For√ßar reload dos valores
    setTimeout(() => {
      const dataInput = form.querySelector('input[name="data"]');
      if (dataInput && !dataInput.value) {
        // Definir data de hoje como padr√£o
        const hoje = new Date().toISOString().split('T')[0];
        dataInput.value = hoje;
        dataInput.setAttribute('data-timestamp', timestamp);
      }
    }, 100);
  }
  
  // Log para debug
  console.log('Formul√°rio de jogos atualizado em:', new Date().toLocaleString());
});

function buscarLocalizacao() {
  const input = document.getElementById('local-input');
  if (!input) return;

  const local = input.value.trim();
  if (!local) {
    alert('Digite um local');
    return;
  }

  window.open(
    'https://www.google.com/maps/search/' + encodeURIComponent(local),
    '_blank'
  );
}
</script>
{% endblock %}
