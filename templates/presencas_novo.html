{% extends "base.html" %}
{% block content %}

<h4 class="mb-3">
  ğŸ“‹ PresenÃ§as e Pagamentos â€” {{ jogo.adversario }}
  <small class="text-muted">({{ jogo.data.strftime('%d/%m/%Y') }})</small>
</h4>

<form method="post" action="{{ url_for('presencas', jogo_id=jogo.id) }}">

<!-- ===== RESUMO ===== -->
<div class="row g-2 mb-3">
  <div class="col-6 col-md-3">
    <div class="card text-center border-primary">
      <div class="card-body p-2">
        <small>ğŸ‘¥ Confirmados</small>
        <h5 class="text-primary mb-0">{{ total_confirmados }}</h5>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center border-success">
      <div class="card-body p-2">
        <small>ğŸ’° Arrecadado</small>
        <h5 class="text-success mb-0">R$ {{ "%.2f"|format(total_arrecadado) }}</h5>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center border-danger">
      <div class="card-body p-2">
        <small>ğŸ’¸ Despesas</small>
        <h5 class="text-danger mb-0">R$ {{ "%.2f"|format(total_despesas) }}</h5>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center border-info">
      <div class="card-body p-2">
        <small>ğŸ’µ Saldo</small>
        <h5 class="text-info mb-0">
          R$ {{ "%.2f"|format(total_arrecadado - total_despesas) }}
        </h5>
      </div>
    </div>
  </div>
</div>

<!-- ===== TABELA RESPONSIVA ===== -->
<div class="table-responsive">
<table class="table table-sm table-hover align-middle">
  <thead class="table-secondary">
    <tr>
      <th>Jogador</th>
      <th>Presente</th>
      <th>Pagou</th>
      <th>Valor</th>
      <th>âš½</th>
      <th>ğŸŸ¥</th>
      <th>â­</th>
    </tr>
  </thead>
  <tbody>
  {% for p in participacoes %}
  {% set bloqueado = (data_jogo_hoje - jogo.data).days > 15 %}
  <tr>
    <td>
      <strong>{{ p.jogador.nome }}</strong><br>
      <small class="text-muted">{{ p.jogador.tipo }}</small>
    </td>

    <!-- CONFIRMOU -->
    <td class="text-center">
      {% if current_user.is_admin() or current_user.jogador_id == p.jogador.id %}
        <input type="checkbox" name="confirmou_{{ p.id }}" {% if p.confirmou %}checked{% endif %}>
      {% else %}
        {{ 'âœ…' if p.confirmou else 'âŒ' }}
      {% endif %}
    </td>

    <!-- PAGOU -->
    <td class="text-center">
      {% if current_user.is_admin() %}
        {% if bloqueado %}
          <input type="checkbox" disabled {% if p.pagou %}checked{% endif %}>
          <input type="hidden" name="pagou_{{ p.id }}" value="{{ 1 if p.pagou else 0 }}">
        {% else %}
          <input type="checkbox" name="pagou_{{ p.id }}" {% if p.pagou %}checked{% endif %}>
        {% endif %}
      {% else %}
        {{ 'âœ…' if p.pagou else 'âŒ' }}
      {% endif %}
    </td>

    <!-- VALOR -->
    <td>
      {% if current_user.is_admin() %}
        {% if bloqueado %}
          <input type="number" class="form-control form-control-sm"
                 value="{{ "%.2f"|format(p.valor_pago) }}" readonly>
          <input type="hidden" name="valor_{{ p.id }}" value="{{ p.valor_pago }}">
        {% else %}
          <input type="number" step="0.01" min="0"
                 class="form-control form-control-sm"
                 name="valor_{{ p.id }}"
                 value="{{ "%.2f"|format(p.valor_pago) }}">
        {% endif %}
      {% else %}
        R$ {{ "%.2f"|format(p.valor_pago) }}
      {% endif %}
    </td>

    <!-- GOLS -->
    <td>
      {% if current_user.is_admin() %}
        <input type="number" min="0" name="gols_{{ p.id }}"
               class="form-control form-control-sm text-center"
               value="{{ p.gols or 0 }}">
      {% else %}
        {{ p.gols or 0 }}
      {% endif %}
    </td>

    <!-- EXPULSO -->
    <td class="text-center">
      {% if current_user.is_admin() %}
        <input type="checkbox" name="expulso_{{ p.id }}" {% if p.expulso %}checked{% endif %}>
      {% else %}
        {{ 'ğŸŸ¥' if p.expulso else 'â€”' }}
      {% endif %}
    </td>

    <!-- CRAQUE -->
    <td class="text-center">
      {% if current_user.is_admin() %}
        <input type="radio" name="craque_id" value="{{ p.jogador.id }}"
               {% if jogo.craque_id == p.jogador.id %}checked{% endif %}>
      {% else %}
        {% if jogo.craque_id == p.jogador.id %}â­{% endif %}
      {% endif %}
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
</div>

<!-- ===== AÃ‡Ã•ES ===== -->
<div class="d-flex flex-wrap gap-2 mt-3">
  <button type="submit" class="btn btn-primary btn-lg">
    ğŸ’¾ Salvar PresenÃ§as
  </button>
  <a href="/pdf-partida/{{ jogo.id }}" class="btn btn-danger btn-lg">
    ğŸ“„ Gerar PDF
  </a>
  <a href="/jogos" class="btn btn-secondary btn-lg">
    Voltar
  </a>
</div>

</form>

{% endblock %}
